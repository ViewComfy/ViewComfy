import Link from "next/link";
import { Button } from "@/components/ui/button";
import { ModeToggle } from "./toggle";
import { UserButton } from "@clerk/nextjs";
import { SignedIn } from "@clerk/nextjs";
import { useViewComfy } from "@/app/providers/view-comfy-provider";
import { useEffect, useState } from "react";
import { Skeleton } from "@/components/ui/skeleton"

export function TopNav() {
    const userManagementEnabled = process.env.NEXT_PUBLIC_USER_MANAGEMENT === "true";
    const { viewComfyState } = useViewComfy();
    const [appTitle, setAppTitle] = useState(viewComfyState.appTitle);
    const [appImg, setAppImg] = useState(viewComfyState.appImg);
    const [isLoading, setIsLoading] = useState(true);

    useEffect(() => {
        if (viewComfyState.appTitle) {
            setAppTitle(viewComfyState.appTitle);
        }
    }, [viewComfyState.appTitle]);

    useEffect(() => {
        if (viewComfyState.viewComfys.length === 0 && !userManagementEnabled) {
            setAppTitle("ViewComfy");
        }
    }, [viewComfyState.viewComfys, userManagementEnabled]);

    useEffect(() => {
        if (viewComfyState.appImg) {
            setAppImg(viewComfyState.appImg);
        }
    }, [viewComfyState.appImg]);

    useEffect(() => {
        if (appTitle) {
            setIsLoading(false);
        }
    }, [appTitle]);

    return (
        <nav className="flex items-center justify-between px-4 py-2 bg-background border-b gap-2">

            {!isLoading ? (<div className="flex items-center">
                <ViewComfyIconButton appTitle={appTitle} appImg={appImg} />
                <span className="ml-2 text-lg font-semibold">{appTitle}</span>
            </div>) : (
                <div className="flex items-center gap-2">
                    <Skeleton className="w-[34px] h-[34px]" />
                    <Skeleton className="w-[200px] h-[24px]" />
                </div>
            )}
            <div className="flex items-center gap-2">
                <Button
                    variant="outline"
                    size="sm"
                    className="gap-1.5 text-sm"
                    asChild
                >
                    <Link href="https://github.com/ViewComfy/ViewComfy" target="_blank" rel="noopener noreferrer">
                        <svg
                            aria-hidden="true"
                            className="octicon octicon-mark-github"
                            height="24"
                            version="1.1"
                            viewBox="0 0 16 16"
                            width="24"
                            fill="currentColor"
                        >
                            <path
                                fillRule="evenodd"
                                d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"
                            />
                        </svg>
                    </Link>
                </Button>
                <Button
                    variant="outline"
                    size="sm"
                    className="text-sm"
                    asChild
                >
                    <Link href="https://discord.gg/DXubrz5R7E" target="_blank" rel="noopener noreferrer" >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            x="0px"
                            y="0px"
                            width="24"
                            height="24"
                            viewBox="0 0 50 50"
                            fill="currentColor"
                        >
                            <title> Discord Invite </title>
                            <path d="M 18.90625 7 C 18.90625 7 12.539063 7.4375 8.375 10.78125 C 8.355469 10.789063 8.332031 10.800781 8.3125 10.8125 C 7.589844 11.480469 7.046875 12.515625 6.375 14 C 5.703125 15.484375 4.992188 17.394531 4.34375 19.53125 C 3.050781 23.808594 2 29.058594 2 34 C 1.996094 34.175781 2.039063 34.347656 2.125 34.5 C 3.585938 37.066406 6.273438 38.617188 8.78125 39.59375 C 11.289063 40.570313 13.605469 40.960938 14.78125 41 C 15.113281 41.011719 15.429688 40.859375 15.625 40.59375 L 18.0625 37.21875 C 20.027344 37.683594 22.332031 38 25 38 C 27.667969 38 29.972656 37.683594 31.9375 37.21875 L 34.375 40.59375 C 34.570313 40.859375 34.886719 41.011719 35.21875 41 C 36.394531 40.960938 38.710938 40.570313 41.21875 39.59375 C 43.726563 38.617188 46.414063 37.066406 47.875 34.5 C 47.960938 34.347656 48.003906 34.175781 48 34 C 48 29.058594 46.949219 23.808594 45.65625 19.53125 C 45.007813 17.394531 44.296875 15.484375 43.625 14 C 42.953125 12.515625 42.410156 11.480469 41.6875 10.8125 C 41.667969 10.800781 41.644531 10.789063 41.625 10.78125 C 37.460938 7.4375 31.09375 7 31.09375 7 C 31.019531 6.992188 30.949219 6.992188 30.875 7 C 30.527344 7.046875 30.234375 7.273438 30.09375 7.59375 C 30.09375 7.59375 29.753906 8.339844 29.53125 9.40625 C 27.582031 9.09375 25.941406 9 25 9 C 24.058594 9 22.417969 9.09375 20.46875 9.40625 C 20.246094 8.339844 19.90625 7.59375 19.90625 7.59375 C 19.734375 7.203125 19.332031 6.964844 18.90625 7 Z M 18.28125 9.15625 C 18.355469 9.359375 18.40625 9.550781 18.46875 9.78125 C 16.214844 10.304688 13.746094 11.160156 11.4375 12.59375 C 11.074219 12.746094 10.835938 13.097656 10.824219 13.492188 C 10.816406 13.882813 11.039063 14.246094 11.390625 14.417969 C 11.746094 14.585938 12.167969 14.535156 12.46875 14.28125 C 17.101563 11.410156 22.996094 11 25 11 C 27.003906 11 32.898438 11.410156 37.53125 14.28125 C 37.832031 14.535156 38.253906 14.585938 38.609375 14.417969 C 38.960938 14.246094 39.183594 13.882813 39.175781 13.492188 C 39.164063 13.097656 38.925781 12.746094 38.5625 12.59375 C 36.253906 11.160156 33.785156 10.304688 31.53125 9.78125 C 31.59375 9.550781 31.644531 9.359375 31.71875 9.15625 C 32.859375 9.296875 37.292969 9.894531 40.3125 12.28125 C 40.507813 12.460938 41.1875 13.460938 41.8125 14.84375 C 42.4375 16.226563 43.09375 18.027344 43.71875 20.09375 C 44.9375 24.125 45.921875 29.097656 45.96875 33.65625 C 44.832031 35.496094 42.699219 36.863281 40.5 37.71875 C 38.5 38.496094 36.632813 38.84375 35.65625 38.9375 L 33.96875 36.65625 C 34.828125 36.378906 35.601563 36.078125 36.28125 35.78125 C 38.804688 34.671875 40.15625 33.5 40.15625 33.5 C 40.570313 33.128906 40.605469 32.492188 40.234375 32.078125 C 39.863281 31.664063 39.226563 31.628906 38.8125 32 C 38.8125 32 37.765625 32.957031 35.46875 33.96875 C 34.625 34.339844 33.601563 34.707031 32.4375 35.03125 C 32.167969 35 31.898438 35.078125 31.6875 35.25 C 29.824219 35.703125 27.609375 36 25 36 C 22.371094 36 20.152344 35.675781 18.28125 35.21875 C 18.070313 35.078125 17.8125 35.019531 17.5625 35.0625 C 16.394531 34.738281 15.378906 34.339844 14.53125 33.96875 C 12.234375 32.957031 11.1875 32 11.1875 32 C 10.960938 31.789063 10.648438 31.699219 10.34375 31.75 C 9.957031 31.808594 9.636719 32.085938 9.53125 32.464844 C 9.421875 32.839844 9.546875 33.246094 9.84375 33.5 C 9.84375 33.5 11.195313 34.671875 13.71875 35.78125 C 14.398438 36.078125 15.171875 36.378906 16.03125 36.65625 L 14.34375 38.9375 C 13.367188 38.84375 11.5 38.496094 9.5 37.71875 C 7.300781 36.863281 5.167969 35.496094 4.03125 33.65625 C 4.078125 29.097656 5.0625 24.125 6.28125 20.09375 C 6.90625 18.027344 7.5625 16.226563 8.1875 14.84375 C 8.8125 13.460938 9.492188 12.460938 9.6875 12.28125 C 12.707031 9.894531 17.140625 9.296875 18.28125 9.15625 Z M 18.5 21 C 15.949219 21 14 23.316406 14 26 C 14 28.683594 15.949219 31 18.5 31 C 21.050781 31 23 28.683594 23 26 C 23 23.316406 21.050781 21 18.5 21 Z M 31.5 21 C 28.949219 21 27 23.316406 27 26 C 27 28.683594 28.949219 31 31.5 31 C 34.050781 31 36 28.683594 36 26 C 36 23.316406 34.050781 21 31.5 21 Z M 18.5 23 C 19.816406 23 21 24.265625 21 26 C 21 27.734375 19.816406 29 18.5 29 C 17.183594 29 16 27.734375 16 26 C 16 24.265625 17.183594 23 18.5 23 Z M 31.5 23 C 32.816406 23 34 24.265625 34 26 C 34 27.734375 32.816406 29 31.5 29 C 30.183594 29 29 27.734375 29 26 C 29 24.265625 30.183594 23 31.5 23 Z" />
                        </svg>
                    </Link>
                </Button>
                <ModeToggle />
                {userManagementEnabled && (
                    <SignedIn>
                        <UserButton />
                    </SignedIn>
                )}
            </div>
        </nav>
    )
}

function ViewComfyIconButton({ appTitle, appImg }: { appTitle?: string, appImg?: string }) {
    return (
        <Button variant="outline" size="icon" aria-label="Home" className="p-0 w-[34px] h-[34px]">
            {!appImg ? (
                <Link href="https://viewcomfy.com" target="_blank" rel="noopener noreferrer" className="flex items-center justify-center w-full h-full">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 900" version="1.1" style={{ width: '34px', height: '34px' }}>
                        <title>{appTitle}</title>
                        <path d="M 124.036 67.244 C 124.056 67.385, 179.297 239.625, 246.793 450 L 369.514 832.500 449.491 832.500 L 529.467 832.500 652.710 450 C 720.493 239.625, 775.963 67.385, 775.976 67.244 C 775.989 67.103, 741.267 67.103, 698.816 67.244 L 621.633 67.500 568.862 253.500 C 539.838 355.800, 507.524 469.650, 497.052 506.500 C 473.710 588.640, 460.304 643.305, 453.029 686 C 451.483 695.075, 449.973 701.825, 449.673 701 C 449.374 700.175, 448.612 696.125, 447.979 692 C 444.357 668.392, 434.033 621.373, 424.485 585 C 415.294 549.987, 407.822 523.569, 343.163 297.500 L 277.379 67.500 200.690 67.244 C 158.510 67.103, 124.016 67.103, 124.036 67.244" stroke="none" fill="#143434" fillRule="evenodd" />
                        <path d="M 49 1.571 C 45.975 2.363, 39.690 4.878, 35.034 7.161 C 19.019 15.012, 6.111 31.298, 1.510 49.460 C 0.176 54.726, -0 101.406, -0 450 C -0 798.594, 0.176 845.274, 1.510 850.540 C 7.409 873.823, 26.177 892.591, 49.460 898.490 C 54.726 899.824, 101.406 900, 450 900 C 798.594 900, 845.274 899.824, 850.540 898.490 C 872.890 892.828, 891.309 875.183, 897.503 853.500 C 898.446 850.200, 899.618 846.719, 900.109 845.764 C 901.154 843.726, 901.352 52.314, 900.307 53.360 C 899.926 53.741, 899.023 51.679, 898.302 48.776 C 897.580 45.874, 895.122 39.690, 892.839 35.034 C 884.988 19.019, 868.702 6.111, 850.540 1.510 C 845.272 0.175, 798.690 0.008, 449.540 0.066 C 109.152 0.123, 53.739 0.331, 49 1.571 M 0.495 450 C 0.495 668.075, 0.610 757.288, 0.750 648.250 C 0.890 539.213, 0.890 360.788, 0.750 251.750 C 0.610 142.713, 0.495 231.925, 0.495 450 M 124.036 67.244 C 124.056 67.385, 179.297 239.625, 246.793 450 L 369.514 832.500 449.491 832.500 L 529.467 832.500 652.710 450 C 720.493 239.625, 775.963 67.385, 775.976 67.244 C 775.989 67.103, 741.267 67.103, 698.816 67.244 L 621.633 67.500 568.862 253.500 C 539.838 355.800, 507.524 469.650, 497.052 506.500 C 473.710 588.640, 460.304 643.305, 453.029 686 C 451.483 695.075, 449.973 701.825, 449.673 701 C 449.374 700.175, 448.612 696.125, 447.979 692 C 444.357 668.392, 434.033 621.373, 424.485 585 C 415.294 549.987, 407.822 523.569, 343.163 297.500 L 277.379 67.500 200.690 67.244 C 158.510 67.103, 124.016 67.103, 124.036 67.244" stroke="none" fill="#fbfbfb" fillRule="evenodd" />
                    </svg>
                </Link>) : (
                <img src={appImg} alt={appTitle} className="w-full h-full" />
            )}
        </Button>
    )

}

